name: Benchmark

on:
  workflow_call:
    inputs:
      opponent:
        required: true
        type: string
      opponent_long:
        required: false
        type: string
      threads:
        required: true
        type: number
      run:
        required: false
        type: string
    outputs:
      wins:
        description: number of wins
        value: ${{ jobs.benchmark.outputs.wins }}
      draws:
        description: number of draws
        value: ${{ jobs.benchmark.outputs.draws }}
      losses:
        description: number of losses
        value: ${{ jobs.benchmark.outputs.losses }}

jobs:
  benchmark:
    name: Benchmark against ${{ inputs.opponent_long || inputs.opponent }}
    runs-on: ubuntu-latest
    env:
      THREADS: ${{ inputs.threads }}
      OPPONENT: ${{ inputs.opponent }}
      OPPONENT_LONG: ${{ inputs.opponent_long || inputs.opponent }}

    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'
    - name: Setup Xvfb
      run: |
        sudo apt-get install -y xvfb
        Xvfb :99 &
        echo "DISPLAY=:99.0" >> $GITHUB_ENV
    - name: Prepare
      run: ${{ inputs.run || 'False' }} || echo "Nothing to prepare"
    - name: Run Benchmark
      run: |
        ./scripts/benchmark.sh $THREADS $OPPONENT > >(tee output.log)
        WINS=$(grep -oP 'Benchmark finished: \+\K\d+' output.log)
        DRAWS=$(grep -oP 'Benchmark finished: \+\d+ =\K\d+' output.log)
        LOSSES=$(grep -oP 'Benchmark finished: \+\d+ =\d+ -\K\d+' output.log)
        echo "wins=$WINS" >> $GITHUB_OUTPUT
        echo "draws=$DRAWS" >> $GITHUB_OUTPUT
        echo "losses=$LOSSES" >> $GITHUB_OUTPUT
        echo "::notice title=Result against $OPPONENT_LONG::$WINS wins, $DRAWS draws, $LOSSES losses"
    - name: Upload Log
      uses: actions/upload-artifact@v3
      with:
        name: ${{ inputs.opponent_long || inputs.opponent }}
        path: output.log
