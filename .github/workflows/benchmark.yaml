name: Benchmark

on:
  workflow_call:
    inputs:
      opponent:
        required: true
        type: string
      suffix:
        required: false
        type: string
      threads:
        required: true
        type: number
      run:
        required: false
        type: string
    outputs:
      wins:
        description: number of wins
        value: ${{ jobs.combine.outputs.wins }}
      draws:
        description: number of draws
        value: ${{ jobs.combine.outputs.draws }}
      losses:
        description: number of losses
        value: ${{ jobs.combine.outputs.losses }}

jobs:
  prepare:
    name: pre-Benchmark
    runs-on: ubuntu-latest
    outputs:
      lines: ${{ steps.calculate.outputs.lines }}
      chunks: ${{ steps.calculate.outputs.chunks }}
      offset: ${{ steps.calculate.outputs.offset }}
      opponent_key: ${{ steps.calculate.outputs.opponent_key }}
      opponent_name: ${{ steps.calculate.outputs.opponent_name }}
    env:
      THREADS: ${{ inputs.threads }}
      OPPONENT: ${{ inputs.opponent }}
      SUFFIX: ${{ inputs.suffix }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Calculate chunking parameters and opponent key
      id: calculate
      run: |
        LINES=$(wc -l < Chess-Challenge/resources/Fens.txt)
        OFFSET=$((LINES / THREADS + (LINES % THREADS != 0)))
        THREADS=$((LINES / OFFSET+ (LINES % OFFSET != 0)))
        CHUNKS=$(seq 0 $((THREADS-1)) | tr '\n' ',' | sed 's/,$//')
        CHUNKS="[$CHUNKS]"
        OPPONENT_KEY="$OPPONENT"
        OPPONENT_NAME="$OPPONENT"
        if [ "$SUFFIX" ]; then
          OPPONENT_KEY="$OPPONENT_$SUFFIX"
          OPPONENT_NAME="$OPPONENT ($SUFFIX)"
        fi
        echo "::notice title=Benchmark against $OPPONENT_NAME::$LINES FENs, $THREADS threads, $OFFSET FENs per thread"
        echo "chunks=$CHUNKS" >> $GITHUB_OUTPUT
        echo "offset=$OFFSET" >> $GITHUB_OUTPUT
        echo "lines=$LINES" >> $GITHUB_OUTPUT
        echo "opponent_key=$OPPONENT_KEY" >> $GITHUB_OUTPUT
        echo "opponent_name=$OPPONENT_NAME" >> $GITHUB_OUTPUT


  benchmark:
    name: Benchmark
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chunk: ${{ fromJson(needs.prepare.outputs.chunks) }}
    env:
      OFFSET: ${{ needs.prepare.outputs.offset }}
      OPPONENT: ${{ inputs.opponent }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'

    - name: Setup Xvfb
      run: |
        sudo apt-get install -y xvfb
        Xvfb :99 &
        echo "DISPLAY=:99.0" >> $GITHUB_ENV


    - name: Prepare
      run: ${{ inputs.run }}

    - name: Benchmark against ${{ inputs.opponent }}
      run: |
        cd Chess-Challenge
        START_LINE=$(( ${{ matrix.chunk }} * $OFFSET + 1 ))
        END_LINE=$(( $START_LINE + $OFFSET - 1 ))
        sed -n "${START_LINE},${END_LINE}p" resources/Fens.txt > temp.txt
        mv temp.txt resources/Fens.txt
        touch output.log
        dotnet run $OPPONENT > >(tee output.log) &
        DOTNET_PID=$!
        while ! grep -q "Match finished:" output.log; do sleep 1; done
        kill $DOTNET_PID
        WINS=$(grep -oP 'Match finished: \+\K\d+' output.log)
        DRAWS=$(grep -oP 'Match finished: \+\d+ =\K\d+' output.log)
        LOSSES=$(grep -oP 'Match finished: \+\d+ =\d+ -\K\d+' output.log)
        cd ..
        echo "+$WINS =$DRAWS -$LOSSES" > res_${{ matrix.chunk }}.txt

    - name: Upload result
      uses: actions/upload-artifact@v3
      with:
        name: res_${{ needs.prepare.outputs.opponent_key }}
        path: res_${{ matrix.chunk }}.txt

  combine:
    name: Combine
    needs:
      - benchmark
      - prepare
    runs-on: ubuntu-latest
    env:
      OPPONENT_KEY: ${{ needs.prepare.outputs.opponent_key }}
      OPPONENT_NAME: ${{ needs.prepare.outputs.opponent_name }}
    outputs:
      wins: ${{ steps.combine.outputs.wins }}
      draws: ${{ steps.combine.outputs.draws }}
      losses: ${{ steps.combine.outputs.losses }}

    steps:
    - name: Download results
      uses: actions/download-artifact@v3

    - name: Combine results
      id: combine
      run: |
        wins=0
        draws=0
        losses=0
        for file in res_$OPPONENT_KEY/*; do
          RESULT=$(cat $file)
          wins=$((wins + $(echo $RESULT | grep -oP '\+\K\d+')))
          draws=$((draws + $(echo $RESULT | grep -oP '=\K\d+')))
          losses=$((losses + $(echo $RESULT | grep -oP '\-\K\d+')))
        done
        echo "wins=$wins" >> $GITHUB_OUTPUT
        echo "draws=$draws" >> $GITHUB_OUTPUT
        echo "losses=$losses" >> $GITHUB_OUTPUT
        echo "::notice title=Result against $OPPONENT_NAME::$wins wins, $draws draws, $losses losses"
