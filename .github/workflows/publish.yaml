name: Benchmark & Publish

on:
  workflow_call:
    inputs:
      opponent:
        required: true
        type: string
      wins:
        required: true
        type: number
      draws:
        required: true
        type: number
      losses:
        required: true
        type: number

jobs:

  notice:
    runs-on: ubuntu-latest
    env:
      WINS: ${{ inputs.wins }}
      DRAWS: ${{ inputs.draws }}
      LOSSES: ${{ inputs.losses }}
      OPPONENT: ${{ inputs.opponent }}
    steps:
      - run: |
          echo "::notice title=Results against $OPPONENT::$WINS wins, $DRAWS draws, $LOSSES losses"

  publish:
    if: github.event_name == 'pull_request' || github.event_name == 'issue_comment'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Calculate and export context
        id: prepare
        run: |
          LAST_COMMIT_SHA=${{ github.event.pull_request.head.sha }}
          SHORT_SHA=$(echo $LAST_COMMIT_SHA | cut -c 1-7)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Edit PR
        uses: actions/github-script@v6
        with:
          script: |
            const opponent = '${{ inputs.opponent }}';
            const wins = '${{ inputs.wins }}';
            const draws = '${{ inputs.draws }}';
            const losses = '${{ inputs.losses }}';
            const shortSha = '${{ steps.prepare.outputs.short_sha }}';
            const pull_number = ${{ github.event.pull_request.number || 'null' }};
            const comment_number = ${{ github.event.comment.id || 'null' }};

            let origin = null;
            if (pull_number) {
              origin = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pull_number
              });
            } else if (comment_number) {
              origin = await github.pulls.getComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: comment_number
              });
            }

            const existingContent = origin.data.body || '';
            let newContent = existingContent;
            let benchmarkIndexStart = existingContent.indexOf('<!-- benchmark start -->');
            let benchmarkIndexEnd = existingContent.indexOf('<!-- benchmark end -->');
            let benchmarkSection = '';

            const newLine = `| ${opponent} | ${wins} | ${draws} | ${losses} | ${shortSha} |\n`;

            if (benchmarkIndexStart === -1) {
              // Benchmark section does not exist. Add it.
              benchmarkSection = `\n<!-- benchmark start -->\n| Opponent | Wins | Draws | Losses | Commit |\n| --- | --- | --- | --- | --- |\n${newLine}<!-- benchmark end -->\n`;
              newContent += benchmarkSection;
            } else {
              // Benchmark section exists. Update it.
              benchmarkSection = existingContent.slice(benchmarkIndexStart + 23, benchmarkIndexEnd);
              let opponentIndex = benchmarkSection.indexOf(`| ${opponent} |`);

              if (opponentIndex === -1) {
                // Opponent row does not exist. Add it.
                benchmarkSection += newLine;
              } else {
                // Opponent row exists. Update it.
                const opponentIndexEnd = benchmarkSection.indexOf('\n', opponentIndex);
                benchmarkSection = benchmarkSection.slice(0, opponentIndex) + newLine + benchmarkSection.slice(opponentIndexEnd+1);
              }

              newContent = existingContent.slice(0, benchmarkIndexStart + 23) + benchmarkSection + existingContent.slice(benchmarkIndexEnd);
            }

            if (pull_number) {
              github.rest.pulls.update({
                pull_number: pull_number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: newContent
              });
            } else if (comment_number) {
              github.pulls.updateComment({
                comment_id: comment_number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: newContent
              });
            }
